<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史地理工具 - HistoryMap</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 工具栏 -->
    <div id="toolbar">
        <!-- 工具区域 -->
        <div class="toolbar-section tools-section">
            <!-- 将标题模块移至工具选项卡正上方 -->
            <div class="title-section" aria-label="历史地理笔记标题">
                <h1>历史地理笔记</h1>
            </div>
            <div class="tool-group">
                <span class="section-label">工具:</span>
                <button id="pinToolBtn" class="tool-btn">图钉</button>
                <button id="selectToolBtn" class="tool-btn active">选择</button>
                <button id="importBtn" class="tool-btn">📁 导入</button>
            </div>
            
            <!-- 隐藏的文件输入 -->
            <input type="file" id="fileInput" accept=".md" multiple style="display: none;">

        </div>
        
        <!-- 过滤区域 -->
        <div class="toolbar-section filters-section">
            <span class="section-label">过滤:</span>
            <div class="filter-controls">
                <div class="control-item">
                    <label for="tagFilter">标签:</label>
                    <select id="tagFilter" class="styled-select">
                        <option value="">显示全部</option>
                    </select>
                </div>
                <div class="control-item year-range">
                    <label>日期区间:</label>
                    <div class="date-range-inputs">
                        <div class="date-group">
                            <span class="date-group-label">起始</span>
                            <label for="startYear">年</label>
                            <input type="text" id="startYear" class="styled-input small-input" placeholder="YYYY" pattern="^-?\d{1,4}$" title="年份格式：YYYY，可选负号表示公元前">
                            <label for="startMonth">月</label>
                            <input type="number" id="startMonth" class="styled-input small-input" placeholder="MM" min="1" max="12" inputmode="numeric" title="月份范围：01-12">
                            <label for="startDay">日</label>
                            <input type="number" id="startDay" class="styled-input small-input" placeholder="DD" min="1" max="31" inputmode="numeric" title="日期范围：01-31">
                        </div>
                        <div class="date-group">
                            <span class="date-group-label">结束</span>
                            <label for="endYear">年</label>
                            <input type="text" id="endYear" class="styled-input small-input" placeholder="YYYY" pattern="^-?\d{1,4}$" title="年份格式：YYYY，可选负号表示公元前">
                            <label for="endMonth">月</label>
                            <input type="number" id="endMonth" class="styled-input small-input" placeholder="MM" min="1" max="12" inputmode="numeric" title="月份范围：01-12">
                            <label for="endDay">日</label>
                            <input type="number" id="endDay" class="styled-input small-input" placeholder="DD" min="1" max="31" inputmode="numeric" title="日期范围：01-31">
                        </div>
                    </div>
                    <div id="dateFilterMsg" class="input-msg" aria-live="polite"></div>
                </div>
                <div class="control-buttons">
                    <button id="filterBtn" class="action-btn primary">过滤</button>
                    <button id="clearFilterBtn" class="action-btn secondary">清除</button>
                </div>
            </div>
        </div>
        
        <!-- 视图区域 -->
        <div class="toolbar-section view-section">
            <span class="section-label">视图:</span>
            <div class="layer-group">
                <button id="layerBtn" class="layer-btn action-btn">🗺️ 图层</button>
                <div id="layerDropdown" class="layer-dropdown">
                    <div class="layer-option" data-layer="basic">🏙️ 高德地图（基本）</div>
                    <div class="layer-option" data-layer="satellite">🛰️ 高德地图（卫星）</div>
                    <div class="layer-option" data-layer="openstreet">🗺️ OpenStreet</div>
                    <div class="layer-option" data-layer="google">🌍 GoogleMap</div>
                    <div class="layer-option" data-layer="google_satellite">🛰️ Google Map（卫星）</div>
                </div>
            </div>
        </div>

        <!-- 帮助区域（右侧） -->
        <div class="toolbar-section help-section" style="margin-left: auto;">
            <button id="helpBtn" class="tool-btn" title="帮助">❓ 帮助</button>
        </div>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- 帮助弹窗组件 -->
    <help-modal id="helpModal"></help-modal>

    <!-- 图钉信息弹窗 -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>添加历史标记</h2>
            <form id="pinForm">
                <!-- 基础信息区：日期与标签 -->
                <fieldset class="form-section">
                    <legend>基础信息</legend>
                    <div class="form-group">
                        <label for="date">日期 (必填):</label>
                        <input type="text" id="date" required placeholder="例如: 1949-10-01 或 -0300-01-01" pattern="^-?\d{1,4}-\d{2}-\d{2}$" title="格式为 YYYY-MM-DD，可选负号表示公元前">
                    </div>
                    <div class="form-group">
                        <label for="category">标签 (可多选):</label>
                        <div class="tag-selector">
                            <div id="availableTags" class="available-tags">
                                <!-- 可选标签将在这里动态加载 -->
                            </div>
                            <div id="selectedTags" class="selected-tags">
                                <div class="selected-tags-label">已选标签:</div>
                                <div id="selectedTagsList" class="selected-tags-list">
                                    <!-- 已选标签将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <!-- 标题输入区 -->
                <fieldset class="form-section">
                    <legend>标题</legend>
                    <div class="form-group">
                        <label for="title">标题 (必填，≤50字):</label>
                        <div class="title-input-wrap">
                            <input type="text" id="title" maxlength="50" required placeholder="请输入标题">
                            <span id="titleCounter" class="char-counter">0 / 50</span>
                        </div>
                    </div>
                </fieldset>

                <!-- 正文编辑区（Markdown） -->
                <fieldset class="form-section">
                    <legend>正文（Markdown 可选）</legend>
                    <div class="form-group">
                        <label for="body">正文:</label>
                        <textarea id="body" rows="7" placeholder="支持 Markdown 格式（可选）"></textarea>
                    </div>
                </fieldset>
                <div class="form-group">
                    <label>图钉样式:</label>
                    <div class="pin-style-controls">
                        <div class="control-item">
                            <label for="modalPinColor">颜色:</label>
                            <select id="modalPinColor" class="styled-select">
                                <option value="auto">自动(按年份)</option>
                                <option value="red">红色</option>
                                <option value="green">绿色</option>
                                <option value="blue">蓝色</option>
                                <option value="yellow">黄色</option>
                                <option value="purple">紫色</option>
                                <option value="orange">橙色</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label for="modalPinStyle">样式:</label>
                            <select id="modalPinStyle" class="styled-select">
                                <option value="circle">圆形</option>
                                <option value="square">方形</option>
                                <option value="triangle">三角形</option>
                                <option value="diamond">菱形</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="submit">确认</button>
                    <button type="button" id="saveAsMarkdownBtn">保存</button>
                    <button type="button" id="cancelBtn">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 图钉详情弹窗 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>历史标记详情</h2>
            <div id="detailContent">
                <!-- 详情内容将在这里动态加载 -->
            </div>
            <div class="form-buttons">
                <button id="editBtn">编辑</button>
                <button id="deleteBtn">删除</button>
                <button id="closeDetailBtn">关闭</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- 主要JavaScript -->
    <!-- Markdown 解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
